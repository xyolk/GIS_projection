<view class="page-container" wx:if="{{!isLoading && shop}}">

<t-swiper 
  current="{{0}}" 
  autoplay="{{true}}" 
  navigation="{{ { type: 'dots-bar' } }}"
  list="{{shop.coverImages}}"
  t-class="hero-swiper"
  image-props="{{ { mode: 'aspectFill' } }}"
  bind:click="onPreviewImage"
/>

<view class="main-card float-up">
  <view class="header-section">
    <view class="shop-name">{{shop.name}}</view>
    <view class="rating-row">
      <t-rate value="{{shop.rating}}" size="14" gap="4" allowHalf readonly color="#ff9800" />
      <text class="rating-text">{{shop.rating}}分</text>
      <text class="review-count">({{shop.reviewCount}}条点评)</text>
      <text class="price-text">¥{{shop.perCapita}}/人</text>
    </view>
    <view class="tag-row">
      <t-tag class="shop-tag" wx:for="{{shop.tags}}" wx:key="index" variant="light" theme="warning" size="small">{{item.text}}</t-tag>
    </view>
  </view>

  <view class="action-bar-grid">
    <view class="action-item" bindtap="onOpenMap">
      <view class="icon-circle"><t-icon name="location" size="40rpx" color="#333" /></view>
      <text>导航</text>
    </view>
    <view class="action-item" bindtap="onCallShop">
      <view class="icon-circle"><t-icon name="call" size="40rpx" color="#333" /></view>
      <text>电话</text>
    </view>
    <view class="action-item">
      <view class="icon-circle"><t-icon name="share" size="40rpx" color="#333" /></view>
      <text>分享</text>
    </view>
    <view class="action-item" bindtap="onBookTable">
      <view class="icon-circle highlight"><t-icon name="time" size="40rpx" color="#fff" /></view>
      <text class="highlight-text">预约</text>
    </view>
  </view>
  
  <view class="divider-line"></view>

  <view class="persona-section">
    <view class="section-title">
      <t-icon name="chart-pie" size="32rpx" color="#ff9800" style="margin-right:8rpx"/>
      <text>商家画像 & Vibe</text>
    </view>
    
    <view class="persona-card">
      <view class="match-box">
        <view class="match-score">{{shop.matchScore}}%</view>
        <view class="match-label">口味契合度</view>
      </view>
    
      <view class="vibe-tags">
        <view class="vibe-intro">根据你的历史喜好，这家店：</view>
        <view class="tags-wrapper">
           <text class="vibe-item" wx:for="{{shop.vibeTags}}" wx:key="index"># {{item}}</text>
        </view>
      </view>
    </view>
  </view>
</view>

<view class="tabs-container">
  <t-tabs 
    value="{{currentTab}}" 
    bind:change="onTabChange" 
    t-class="custom-tabs" 
    t-class-item="custom-tab-item"
    t-class-active="custom-tab-active"
    sticky
  >
    <t-tab-panel label="推荐菜品" value="menu" />
    <t-tab-panel label="商家信息" value="info" />
    <t-tab-panel label="用户评价" value="review" />
  </t-tabs>
</view>

<view class="content-body">
  
  <view wx:if="{{currentTab === 'menu'}}" class="menu-list">
    <block wx:for="{{shop.topMenu}}" wx:key="id">
      <view class="menu-item-card">
        <t-image src="{{item.imageUrl}}" mode="aspectFill" width="160rpx" height="160rpx" shape="round" />
        <view class="menu-info">
          <view class="menu-name">{{item.name}}</view>
          <view class="menu-stat">
            <t-icon name="thumb-up" size="24rpx" color="#999"/> {{item.recommendCount}}人推荐
          </view>
          <view class="menu-price">¥{{item.price}}</view>
        </view>
      </view>
    </block>
  </view>

  <view wx:if="{{currentTab === 'info'}}" class="info-panel">
    <t-cell-group theme="card">
      <t-cell title="营业时间" note="{{shop.openTime}}" left-icon="time" />
      <t-cell title="商家地址" label="{{shop.address}}" left-icon="location" bind:click="onOpenMap" arrow />
      <t-cell title="联系电话" note="{{shop.phone}}" left-icon="call" bind:click="onCallShop" arrow />
    </t-cell-group>
    
    <view class="map-preview" bindtap="onOpenMap">
      <t-image src="https://tdesign.gtimg.com/miniprogram/images/example2.png" width="100%" height="200rpx" mode="aspectFill" />
      <view class="map-mask">点击查看地图</view>
    </view>
  </view>

  <view wx:if="{{currentTab === 'review'}}" class="review-container">
    
    <view class="recommend-section">
      <view class="section-title">
        <view class="title-left">
          <t-icon name="thumb-up" size="36rpx" color="#ff9800" style="margin-right:8rpx;" />
          <text>网友推荐必吃</text>
        </view>
        <text class="title-right">查看全部 {{shop.topMenu.length}} 道 ></text>
      </view>
      
      <scroll-view scroll-x class="menu-scroll" enable-flex>
        <block wx:for="{{shop.topMenu}}" wx:key="id">
          <view class="menu-card-h">
            <view class="menu-img-box">
              <t-image src="{{item.imageUrl}}" width="100%" height="100%" mode="aspectFill" />
              <view class="rank-badge {{index < 3 ? 'top3' : ''}}">TOP {{index + 1}}</view>
            </view>
            <view class="menu-info-h">
              <view class="menu-name-h text-ellipsis">{{item.name}}</view>
              <view class="menu-price-row">
                <text class="price">¥{{item.price}}</text>
                <text class="rec-count">{{item.recommendCount}}人推</text>
              </view>
            </view>
          </view>
        </block>
        <view style="width: 24rpx; flex-shrink: 0;"></view>
      </scroll-view>
    </view>

    <view class="review-dashboard">
      <view class="score-header">
        <view class="score-big">
          <text class="score-num">{{shop.reviewStats.averageScore}}</text>
          <view class="score-stars">
            <text class="score-txt">综合评分</text>
            <t-rate value="{{shop.reviewStats.averageScore}}" size="12" gap="2" allowHalf readonly />
          </view>
        </view>
        <view class="score-sub">
          <view class="sub-item">口味 <text>{{shop.reviewStats.tasteScore}}</text></view>
          <view class="sub-item">环境 <text>{{shop.reviewStats.environmentScore}}</text></view>
          <view class="sub-item">服务 <text>{{shop.reviewStats.serviceScore}}</text></view>
        </view>
      </view>
      
      <scroll-view scroll-x class="tag-scroll" enable-flex>
        <view class="tag-list">
          <view 
            wx:for="{{shop.reviewStats.tags}}" 
            wx:key="id" 
            class="filter-tag {{currentTagId === item.id ? 'active' : ''}} {{item.type}}"
            bindtap="onTapReviewTag"
            data-id="{{item.id}}"
          >
            {{item.text}} {{item.count}}
          </view>
        </view>
      </scroll-view>
    </view>

    <view class="review-feed">
      <block wx:for="{{shop.reviews}}" wx:key="id">
        <view class="review-card" bindtap="onTapReviewCard" data-id="{{item.id}}">
          
          <view class="card-header">
            <t-avatar image="{{item.avatarUrl}}" size="small" />
            <view class="user-meta">
              <view class="user-name-row">
                <text class="name">{{item.userName}}</text>
                <t-tag wx:if="{{item.userLevel}}" size="small" variant="light" theme="warning" class="level-tag">LV.{{item.userLevel}}</t-tag>
              </view>
              <view class="date-row">
                <text class="date">{{item.date}}</text>
              </view>
            </view>
            <t-rate value="{{item.rating}}" size="12" gap="2" count="{{5}}" readonly />
          </view>

          <view class="card-content {{item.content.length > 60 ? 'ellipsis' : ''}}">
            {{item.content}}
          </view>

          <view class="card-imgs" wx:if="{{item.images && item.images.length}}">
            <view 
              class="img-box" 
              wx:for="{{item.images}}" 
              wx:for-item="img" 
              wx:key="*this"
              catchtap="onPreviewReviewImage" 
              data-current="{{img}}" 
              data-urls="{{item.images}}"
            >
              <t-image src="{{img}}" width="100%" height="100%" mode="aspectFill" class="t-image" />
            </view>
          </view>

          <view class="merchant-reply" wx:if="{{item.merchantReply}}">
            <text class="reply-label">商家回复：</text>
            <text>{{item.merchantReply}}</text>
          </view>

          <view class="card-footer">
            <view class="footer-left">
              <text class="browser-count">浏览 {{item.replyCount * 103 + 20}}</text>
            </view>
            <view class="action-btns">
              <view class="icon-btn {{item.isLiked ? 'liked' : ''}}" catchtap="onLikeReview" data-index="{{index}}">
                <t-icon name="{{item.isLiked ? 'heart-filled' : 'heart'}}" size="36rpx" />
                <text>{{item.likeCount || '点赞'}}</text>
              </view>
              <view class="icon-btn">
                <t-icon name="chat" size="36rpx" />
                <text>{{item.replyCount || '评论'}}</text>
              </view>
            </view>
          </view>

        </view>
      </block>
    </view>
    
    <view class="feed-loading">
      <t-loading theme="dots" size="40rpx" inherit-color text="加载更多评价..." />
    </view>
    
  </view>
  </view>
<view style="height: 100rpx;"></view>
</view>

<view wx:else class="loading-container">
<t-loading theme="circular" size="40rpx" text="加载美味中..." />
</view>