**“寻味金陵”小程序-需求文档**

**文档说明：** 本文档基于《寻味金陵小程序需求文档》。旨在帮你快速理解需求，了解小程序的大概功能和界面，但不强制到具体设计细节，具体UI细节应参照同文件夹下的UI.md来进行设计；具体数据流逻辑应参照同文件夹下的dataset.md来进行设计；而具体数据库应该在云开发环境建立列表以实现动态交互。

**1. 这个小程序是干嘛的？**
* 这是一个服务于“食客、商家、管理员”三方角色的美食生态系统
* **食客**：发现身边美食，一键导航直达，分享真实评价
* **商家**：数字化管理门店信息，查看经营数据，维护店铺口碑
* **管理员**：监控系统健康，审核内容合规，动态配置规则

**2. 主要功能有哪些？**
* **角色与入口**
* 根据登录账号身份（食客/商家/管理员），自动展示对应的功能界面
* **食客端（核心流程：发现—决策—抵达—反馈）**
* **首页（发现）**
    * 默认以当前定位半径调取周边餐厅
    * 支持按预设（口味、忌口、人均）及历史行为（浏览、收藏、评分）自动加权重排
    * 列表滑动更新：每次滑动记录兴趣信号，下次启动自动更新排序
* **餐厅详情页（决策）**
    * 首屏展示核心信息：菜单、人均、营业时间、评分细项（口味/服务/环境）、停车场及公交步行时间
    * 导航悬浮按钮：常驻卡片下方，点击直接进入路线规划
* **路线导航（抵达）**
    * 提供驾车、步行、公交三套方案（颜色区分时长/里程/拥堵）
    * 默认选中最快路线
* **评价中心（反馈）**
    * 半弹窗形式：五星评级 + “锐评标签”横滑条（如“性价比之王”） + 选填图片
    * 提交成功提示“已用于优化推荐”
* **社交与榜单**
    * 每日更新“热门榜”“小众榜”“话题榜”
    * 支持一键分享至微信/微博，支持收藏餐厅（反向影响推荐权重）

* **交互说明**
    * 四个界面彼此应该可以灵活交互，如点击探索界面的红心可以弹出添加到我的收藏夹、
    在收藏夹详情界面关注用户可动态改变我的社媒界面的关注人数，点击关注人数也可访问关注者的收藏系列等。

* **商家端（核心流程：管理—复盘—维护）**
* **店铺信息管理（门面）**
    * 实时编辑：菜单调价、营业时间、节假日公告、新菜照片、优惠券
    * 更新即时生效，前端用户可见
* **数据驾驶舱（数据）**
    * 折线图：展示日/周/月订单、营业额、客单价
    * 饼图/柱状图：展示顾客年龄、口味偏好、复购率
    * 漏斗图：展示曝光—点击—收藏—转化路径
* **评价智能中心（口碑）**
    * 新评价30秒内推送，支持公开回复或私信
    * 情感预警：差评关键词连续出现时触发整改建议

* **管理员端（核心流程：审核—维护—监控—配置）**
* **内容审核**
    * 敏感词自动过滤 + 人工复核
    * 处理虚假好评、恶意差评、违规广告
* **数据维护**
    * 处理POI变动（新增/停业/迁址/坐标偏移）
    * 审核通过后触发缓存刷新
* **系统运行监控**
    * 仪表盘：红黄绿三色灯展示CPU、内存、QPS状态
    * 日志查询：保留7天错误/操作日志，支持ID检索
* **规则配置**
    * 在线热更新推荐权重、预警阈值
    * A/B测试：新旧参数并行对比点击率/误报率

**3. 界面和使用感觉要求**
* **界面样子**
* 必须使用“TDesign”界面工具包，保持三端风格统一、专业、高效
* 决策环节强调信息层级：遵循“先核心后细节”原则
* **使用感觉**
* 路径极简：不堆砌按钮，不强制跳转，流程闭环短
* 操作反馈：评价流程控制在10秒内，导航切换无须重新加载
* **速度**
* 推荐算法响应快，列表滑动流畅无感更新
* 数据图表（商家端）加载迅速
* **安全**
* 严格的数据权限控制，保障商家经营数据与用户隐私安全

**4. 关于“智能推荐与反馈闭环”的优化建议**
* **目标**：让用户觉得“越用越懂我”，让商家觉得“经营有方向”
* **具体措施**
* **隐式反馈捕捉**：除了显式的评分，需重点记录用户的“滑过不点”、“点击停留时长”、“路线规划后是否实际到达”等行为数据
* **情感化标签库**：评价标签不局限于“好吃/难吃”，增加场景化标签（如“适合约会”、“工作餐首选”），降低用户思考成本
* **智能预警文案**：商家端收到差评预警时，不仅仅提示“有差评”，而是给出具体建议（如“近期‘上菜慢’关键词频发，建议检查后厨流程”）

**5. 技术实现详细说明**

为了确保食客端的顺滑体验与推荐的精准度，本项目将在地图服务与算法引擎上采用以下技术方案：

**5.1 地图与导航服务实现**
鉴于小程序环境，优先接入 **腾讯位置服务 (Tencent LBS) WebService API**。
应给出.env文件专门用于接入API接口

* **路线规划（驾车/步行/公交）**
    * **接口选型**：腾讯地图 **Direction API**（路线规划接口）
    * **实现逻辑**：
        * **驾车方案 (Driving)**：调用 `direction/v1/driving`。
            * **拥堵颜色区分**：开启 `traffic_condition=1` 参数。系统解析返回的 `polyline` 坐标点串中的 `traffic_condition` 字段（0:畅通, 1:缓行, 2:拥堵），前端据此绘制绿/黄/红三色折线。
            * **多策略**：接口自动返回“时间最短”、“距离最短”等方案，前端优先展示 `duration`（耗时）最小的方案。
        * **步行方案 (Walking)**：调用 `direction/v1/walking`，用于1km以内的短途导航。
        * **公交方案 (Transit)**：调用 `direction/v1/transit`。
            * **步行时间提取**：解析返回数据 `steps` 数组中 `mode: WALKING` 的片段，累加该路段的 `duration`，在界面显著位置标注“需步行 xx 分钟”。

* **周边设施（停车场）**
    * **接口选型**：腾讯地图 **Place API**（地点搜索接口）
    * **实现逻辑**：
        * 调用 `place/v1/search` 接口。
        * **参数配置**：设置 `boundary=nearby(lat,lng,1000)`（以餐厅坐标为圆心，1000米半径），关键字 `keyword=停车场`。
        * **展示**：在餐厅卡片仅展示最近的一个停车场名称及直线距离。

**5.2 智能推荐与加权排序算法**
采用 **“基于内容的过滤 + 行为加权”混合推荐算法**，确保冷启动期有推荐，使用越久越精准。

* **核心算法逻辑**
    推荐系统将通过计算“总得分”对候选餐厅进行排序，得分计算公式如下：
    $$Score = (W_{base} \times S_{match}) + (W_{ctx} \times S_{context}) + (W_{act} \times S_{behavior})$$

* **具体因子说明**
    1.  **$S_{match}$ (基础匹配度)**：
        * **硬性过滤**：若餐厅包含用户“忌口”标签（如海鲜过敏），直接剔除。
        * **口味匹配**：计算用户预设口味向量（如[辣, 甜]）与餐厅标签向量的 **Jaccard 相似系数**。
        * **预算匹配**：餐厅人均价格落在用户预设区间内得满分，否则按偏离程度呈高斯衰减。

    2.  **$S_{context}$ (场景上下文)**：
        * **距离衰减**：基于用户当前定位，距离越近权重越高（Score $\propto 1/Distance$）。
        * **时段匹配**：当前时间若处于餐厅营业时间且非打烊前30分钟，给予加权。

    3.  **$S_{behavior}$ (历史行为加权)**：
        * 根据用户对某类餐厅的历史操作赋予不同分值，累加后归一化：
            * **点击/浏览**：+1分
            * **导航/分享**：+3分
            * **收藏**：+5分
            * **五星好评**：+10分
        * *注：每次滑动列表刷新时，系统会更新上述行为数据，实时调整下一次推荐列表的排序。*

* **数据结构准备**
    * **用户画像表**：存储 `User_ID`, `Pref_Tags` (口味), `Avoid_Tags` (忌口), `History_Vector` (历史交互权重)。
    * **餐厅特征表**：存储 `Shop_ID`, `Tags` (标签), `Price` (价格), `Location` (经纬度)。

【运行环境】
- 微信小程序云开发，云开发环境 ID：gisenv-6gzyxup1aa1bbc9d
- 使用 TDesign 组件库 "tdesign-miniprogram": "^1.11.2"，已在 package.json 中声明
- 腾讯位置服务 key 使用占位符 {{__TENCENT_MAP_KEY__}}，不要硬编码

【数据库集合】（先创建，权限 read:true / write:owner）
1. users
   _id, _openid, nickName, avatarUrl, prefTags[string], avoidTags[string], location GeoPoint, updateTime Date
2. shops
   _id, name, coverPic, location GeoPoint, address, phone, openHours[string], tags[string], price Number, score Number, ownerOpenid
3. reviews
   _id, _openid, shopId, stars Number, tags[string], pics array<string>, createTime Date

// user_fav_shops
{
  _id: string,          // 云开发自动
  _openid: string,      // 收藏者
  shopId: string,       // 店铺 _id
  createTime: Date,     // 收藏时间
}

// user_follow_users
{
  _id: string,
  _openid: string,      // 粉丝
  targetOpenid: string, // 被关注人
  createTime: Date,
}

【页面拆分】
- 食客端 4 个 Tab：首页 discovery / 榜单 ranking / 收藏 favorites / 我的 profile
- 每个 Tab 都是独立 Page，放在 pages/discovery/index 等路径
- 仅 discovery 需要下拉刷新 + 上拉加载更多

【discovery 页面需求】
1. onLoad 获取用户当前坐标，写入 users.location（没有就新建）
2. 按「推荐算法」拉取附近 20 条 shops，写进 this.setData({shopList})，用 t-card 渲染
3. 推荐算法：云函数 getNearbyShops，内部按 5.2 公式 Score = Wbase*Smatch + Wctx*Scontext + Wact*Sbehavior 排序，返回 shopList
4. 下滑到底部触发上拉，skip+20 继续拉取
5. 点击 shop 跳转到 pages/shopDetail/index?shopId=xxx
6. 点击卡片心形图标：如果已收藏则删除 users.prefTags["favorite_shopId"], 否则添加；成功后只改数据，不手动改 DOM，依赖 setData 自动刷新

【代码风格】
-  async/await + wx.cloud.database()
-  每个查询加 .limit(20).orderBy('updateTime','desc')
-  禁止出现 document、window 等 Web API
-  所有图片用 <t-image lazy /> 并给默认占位图
-  wxml 里只出现 {{}} 绑定，禁止出现 wx:if 嵌套超 2 层，复杂判断在 JS 里先算好布尔值

【输出物】
1. app.js 中云开发初始化代码
2. cloudfunctions/getNearbyShops/index.js 完整实现（含 Score 排序逻辑）
3. pages/discovery/index.{js,wxml,wxss} 三件套，满足上述需求
4. 一键部署清单：告诉我先在云开发控制台创建哪几个集合、哪几条索引（location 2dsphere）
5. 命名风格统一、简约，复用性为第一准则，强调动态交互，灵活使用云数据库